import type { IPageData, ITourDefinition } from '../types';

export const TOURS_DATA: ITourDefinition[] = [
  { wp_id: '43', title: 'Туры на Алтай 2026', slug: 'туры-на-алтай-2026' },
  { wp_id: '44', title: 'Туры на Алтай 2025', slug: 'туры-на-алтай-2025' },
  { wp_id: '25', title: 'Туры на Алтай из Красноярска', slug: 'туры-на-алтай-из-красноярска' },
  { wp_id: '26', title: 'Туры на Алтай из Омска', slug: 'туры-на-алтай-из-омска' },
  { wp_id: '27', title: 'Туры на Алтай из Томска', slug: 'туры-на-алтай-из-томска' },
  { wp_id: '28', title: 'Туры на Алтай из Кемерово', slug: 'туры-на-алтай-из-кемерово' },
  { wp_id: '29', title: 'Туры на Алтай из Новокузнецка', slug: 'туры-на-алтай-из-новокузнецка' },
  { wp_id: '30', title: 'Туры на Алтай из Иркутска', slug: 'туры-на-алтай-из-иркутска' },
  { wp_id: '46', title: 'Конные туры на Алтае', slug: 'конные-туры-на-алтае' },
  { wp_id: '45', title: 'Джип-туры по Алтаю', slug: 'джип-туры-по-алтаю' },
  { wp_id: '42', title: 'Белуха: туры и маршруты', slug: 'белуха' },
  { wp_id: '41', title: 'Усть-Кокса: туры и что посмотреть', slug: 'усть-кокса' },
  { wp_id: '37', title: 'Перевал Кату-Ярык: туры и как добраться', slug: 'перевал-кату-ярык' },
  { wp_id: '39', title: 'Водопад Учар: туры, тропа и советы', slug: 'водопад-учар' },
  { wp_id: '38', title: 'Долина Чулышмана: маршрут, туры и водопады', slug: 'долина-чулышмана' },
  { wp_id: '310', title: 'Туры на Алтай на 5 дней', slug: 'туры-на-алтай-5-дней' },
  { wp_id: '309', title: 'Туры на Алтай на 3 дня', slug: 'туры-на-алтай-3-дня' },
  { wp_id: '308', title: 'Индивидуальные туры на Алтае', slug: 'индивидуальные-туры-на-алтае' },
  { wp_id: '252', title: 'Джип-туры на Алтай', slug: 'джип-туры-на-алтай' },
  { wp_id: '40', title: 'Алтай Марс (Кызыл-Чин): экскурсии и туры', slug: 'алтай-марс-кызыл-чин-экскурсии-и-туры' },
  { wp_id: '36', title: 'Гейзеровое озеро на Алтае: как попасть и туры', slug: 'гейзеровое-озеро-на-алтае-как-попасть' },
  { wp_id: '35', title: 'Телецкое озеро: туры и экскурсии', slug: 'телецкое-озеро-туры-и-экскурсии' },
  { wp_id: '34', title: 'Чуйский тракт: туры и маршрут', slug: 'чуйский-тракт-туры-и-маршрут' },
  { wp_id: '33', title: 'Туры выходного дня на Алтай', slug: 'туры-выходного-дня-на-алтай' },
  { wp_id: '24', title: 'Туры на Алтай из Барнаула', slug: 'туры-на-алтай-из-барнаула' },
  { wp_id: '23', title: 'Туры на Алтай из Новосибирска', slug: 'туры-на-алтай-из-новосибирска' },
  { wp_id: '59', title: 'Новый год на Алтае 2026: туры и отдых', slug: 'новый-год-на-алтае-2026-туры-и-отдых' },
  { wp_id: '58', title: 'Туры на Алтай с перелетом', slug: 'туры-на-алтай-с-перелетом' },
  { wp_id: '57', title: 'Туры на Горный Алтай', slug: 'туры-на-горный-алтай' },
  { wp_id: '22', title: 'Туры на Алтай из Сибири', slug: 'туры-на-алтай-из-сибири' },
  { wp_id: '21', title: 'Туры на Алтай из Москвы', slug: 'туры-на-алтай-из-москвы' },
  { wp_id: '20', title: 'Туры на Алтай', slug: 'туры-на-алтай' }
];

export const EXCURSIONS_DATA: ITourDefinition[] = [
  { wp_id: '31', title: 'Экскурсии по Горному Алтаю', slug: 'экскурсии-по-горному-алтаю' },
  { wp_id: '32', title: 'Однодневные экскурсии из Горно-Алтайска', slug: 'однодневные-экскурсии-горно-алтайск' }
];

export const LOCATIONS_DATA: ITourDefinition[] = [
  { wp_id: '34', title: 'Чуйский тракт: туры и маршрут', slug: 'чуйский-тракт-туры-и-маршрут' },
  { wp_id: '35', title: 'Телецкое озеро: туры и экскурсии', slug: 'телецкое-озеро-туры-и-экскурсии' },
  { wp_id: '36', title: 'Гейзеровое озеро на Алтае: как попасть и туры', slug: 'гейзеровое-озеро-на-алтае-как-попасть' },
  { wp_id: '37', title: 'Перевал Кату-Ярык: туры и как добраться', slug: 'перевал-кату-ярык' },
  { wp_id: '38', title: 'Долина Чулышмана: маршрут, туры и водопады', slug: 'долина-чулышмана' },
  { wp_id: '39', title: 'Водопад Учар: туры, тропа и советы', slug: 'водопад-учар' },
  { wp_id: '40', title: 'Алтай Марс (Кызыл-Чин): экскурсии и туры', slug: 'алтай-марс-кызыл-чин-экскурсии-и-туры' },
  { wp_id: '41', title: 'Усть-Кокса: туры и что посмотреть', slug: 'усть-кокса' },
  { wp_id: '42', title: 'Белуха: туры и маршруты', slug: 'белуха' }
];

export const TOUR_SLUGS_SET = new Set(TOURS_DATA.map(t => t.slug));
export const TOUR_TITLES_SET = new Set(TOURS_DATA.map(t => t.title));
export const LOCATION_SLUGS_SET = new Set(LOCATIONS_DATA.map(l => l.slug));
export const EXCURSION_SLUGS_SET = new Set(EXCURSIONS_DATA.map(e => e.slug));

export const SLUG_ALIASES: { [key: string]: string } = {
  'chuyskiy-trakt': 'чуйский-тракт-туры-и-маршрут',
  'teleckoe-ozero': 'телецкое-озеро-туры-и-экскурсии',
  'geyzerovoe-ozero-na-altae-kak-popast-i-tury': 'гейзеровое-озеро-на-алтае-как-попасть',
};

export enum PageCategory {
  TOUR = 'tour',
  BLOG = 'blog',
  LOCATION = 'location',
  SYSTEM = 'system'
}

let allPages: IPageData[] = [];
const pagesBySlug = new Map<string, IPageData>();
let pagesPromise: Promise<void> | null = null;

const cleanContentHtml = (html: string): string => {
  if (!html) return '';

  let cleaned = html;

  // 1. Удаляем блок "<h2>Бронирование</h2>" или "<h2>Контакты</h2>" и следующие за ним кнопки/ссылки
  cleaned = cleaned.replace(/<h2>(Бронирование|Контакты)<\/h2>[\s\S]*?(?=<div [^>]*class="[^"]*wp-block-spacer|<!-- wp:group|<h2>|$)/gi, '');

  // 2. Удаляем блок со спейсером, если он предшествует разделу бронирования/контактов
  cleaned = cleaned.replace(/<div style="height:60px"[^>]*class="wp-block-spacer"><\/div>/gi, '');

  // 3. Удаляем весь блок "Связаться и забронировать"
  const groupRegex = /<!-- wp:group [\s\S]*?<div class="wp-block-group"[\s\S]*?Связаться и забронировать[\s\S]*?<\/div>\s*?<!-- \/wp:group -->/gi;
  cleaned = cleaned.replace(groupRegex, '');

  const simpleGroupRegex = /<div class="wp-block-group"[\s\S]*?Связаться и забронировать[\s\S]*?<\/div>/gi;
  cleaned = cleaned.replace(simpleGroupRegex, '');

  // 4. Удаляем артефакты навигации (Маршруты, Инфо) и CTA-кнопки
  // Если находим характерные признаки "битой" шапки, удаляем всё до первого заголовка или абзаца
  if (cleaned.match(/<(summary|details)>(Маршруты|Инфо)/i) ||
    cleaned.match(/class="(cta|oai-btn|dd)"/i) ||
    cleaned.match(/Забронировать Позвонить Telegram VK/i)) {
    cleaned = cleaned.replace(/^[\s\S]*?(?=<h[1-3])/i, '');
    // Если заголовков нет, но есть абзацы
    if (!cleaned.startsWith('<h')) {
      cleaned = cleaned.replace(/^[\s\S]*?(?=<p)/i, '');
    }
  }

  // 5. Точечное удаление, если что-то осталось (на всякий случай)
  cleaned = cleaned.replace(/<\/details>\s*<details>[\s\S]*?<summary>(Маршруты|Инфо)<\/summary>[\s\S]*?<\/details>/gi, '');
  cleaned = cleaned.replace(/<details>[\s\S]*?<summary>(Маршруты|Инфо)<\/summary>[\s\S]*?<\/details>/gi, '');
  cleaned = cleaned.replace(/<div class="cta">[\s\S]*?(Забронировать|Позвонить|Telegram|VK)[\s\S]*?<\/div>/gi, '');

  // Удаляем остаточные закрывающие теги в самом начале
  cleaned = cleaned.replace(/^(\s*<\/(div|details|p|span|a)>)+/i, '');

  return cleaned.trim();
};

const loadAndParseContent = async () => {
  if (allPages.length > 0) return;

  try {
    const response = await fetch('/04travel-pages.json');
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    const jsonData = await response.json();

    allPages = jsonData.map((p: any) => {
      const rawHtml = p.content_html || p.content?.rendered || '';
      return {
        wp_id: String(p.wp_id),
        title: p.title,
        url: p.url,
        slug: p.slug,
        published: p.date_published || p.published || '',
        modified: p.date_modified || p.modified || '',
        contentHtml: cleanContentHtml(rawHtml),
      };
    });

    console.log(`Loaded ${allPages.length} pages from JSON.`);

    if (allPages.length < 40) {
      console.error(`[contentService] CRITICAL ERROR: Загружено всего ${allPages.length} страниц. Ожидалось >= 40.`);
    }

    allPages.forEach(p => {
      const rawSlug = p.slug || '';
      if (!rawSlug) return;

      try {
        const decoded = decodeURIComponent(rawSlug).toLowerCase();
        pagesBySlug.set(decoded, p);
      } catch (e) {
        pagesBySlug.set(rawSlug.toLowerCase(), p);
      }
    });

  } catch (e) {
    console.error("Failed to load or parse pages from JSON:", e);
    throw e;
  }
};

const ensureLoaded = () => {
  if (!pagesPromise) {
    pagesPromise = loadAndParseContent();
  }
  return pagesPromise;
};

export const getAllPages = async (): Promise<IPageData[]> => {
  await ensureLoaded();
  return allPages;
};

export const getPageBySlug = async (slug: string): Promise<IPageData | null> => {
  await ensureLoaded();
  if (!slug) return null;
  const lower = slug.toLowerCase();
  return pagesBySlug.get(lower) || null;
};

export const getPageCategory = (page: IPageData): PageCategory => {
  if (TOUR_TITLES_SET.has(page.title)) return PageCategory.TOUR;
  if (page.title.startsWith('Локация:')) return PageCategory.LOCATION;
  if (page.title.startsWith('Блог:')) return PageCategory.BLOG;
  if (
    page.title === 'О нас' ||
    page.title === 'Контакты' ||
    page.title === 'ЧаВо' ||
    page.title.toLowerCase().includes('политика')
  ) return PageCategory.SYSTEM;

  return PageCategory.SYSTEM;
};

export function createExcerpt(html: string, maxLength: number = 180): string {
  if (!html) return '';
  const text = html.replace(/<script[\s\S]*?<\/script>/gi, ' ')
    .replace(/<style[\s\S]*?<\/style>/gi, ' ')
    .replace(/<[^>]+>/g, ' ')
    .replace(/\s\s+/g, ' ')
    .trim();
  return text.length > maxLength ? text.slice(0, maxLength).trim() + '…' : text;
}

export default {
  getAllPages,
  getPageBySlug,
  createExcerpt,
  getPageCategory,
  PageCategory
};
